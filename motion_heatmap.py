"""
–•–æ—Ä–æ—à–∞—è —à—É—Ç–∫–∞. –ü—Ä–∏–≤–µ—Ç —Å —é—Ç—É–±–∞

–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–∞ —à—Ç—É–∫–∞? - –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤–∏–¥–µ–æ —Å –≤–∞—É-–∏–ª–ª—é–∑–∏–µ–π, –∑–∞—Ç–µ–º –ø—É—Ç—å –∫ –Ω–µ–º—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –ø—Ä–æ–≥—Ä–∞–º–º—É. –ù–∞ –≤—ã—Ö–æ–¥–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –¥—Ä—É–≥–æ–µ –≤–∏–¥–µ–æ —Å –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π. –ú–æ–∂–Ω–æ —Å–∫—Ä–∏–Ω–∏—Ç—å —Å–∫–æ–ª—å–∫–æ —Ö–æ—á–µ—à—å <3

–°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç–∞–≤—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:
pip install opencv-python numpy
"""

import cv2
import numpy as np
import sys
import os

def create_motion_heatmap_video(input_path, output_path, decay_speed=2.0, threshold=25):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–∏–¥–µ–æ, —Å–æ–∑–¥–∞–≤–∞—è —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É –¥–≤–∏–∂–µ–Ω–∏—è —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º –∑–∞—Ç—É—Ö–∞–Ω–∏—è.
    
    :param input_path: –ü—É—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –≤–∏–¥–µ–æ
    :param output_path: –ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    :param decay_speed: –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞—Ç—É—Ö–∞–Ω–∏—è —Å–ª–µ–¥–∞ (—á–µ–º –º–µ–Ω—å—à–µ, —Ç–µ–º –¥–ª–∏–Ω–Ω–µ–µ "—Ö–≤–æ—Å—Ç" –¥–≤–∏–∂–µ–Ω–∏—è)
    :param threshold: –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —à—É–º–∞)
    """
    
    # 1. –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–µ–æ
    cap = cv2.VideoCapture(input_path)
    if not cap.isOpened():
        print(f"‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ {input_path}")
        return

    # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∏–¥–µ–æ
    width = int(cap.get(cv2.CAP_PROP_FRAME_WIDTH))
    height = int(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))
    fps = cap.get(cv2.CAP_PROP_FPS)
    total_frames = int(cap.get(cv2.CAP_PROP_FRAME_COUNT))
    
    print(f"üìπ –í–∏–¥–µ–æ: {width}x{height}, {fps} FPS, {total_frames} –∫–∞–¥—Ä–æ–≤")

    # 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å –Ω–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–¥–µ–∫ mp4v
    fourcc = cv2.VideoWriter_fourcc(*'mp4v')
    out = cv2.VideoWriter(output_path, fourcc, fps, (width, height))

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    ret, first_frame = cap.read()
    if not ret:
        return

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä –≤ –æ—Ç—Ç–µ–Ω–∫–∏ —Å–µ—Ä–æ–≥–æ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    prev_gray = cv2.cvtColor(first_frame, cv2.COLOR_BGR2GRAY)
    
    # –°–æ–∑–¥–∞–µ–º "–∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä" - –±—É—Ñ–µ—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–ø–ª–æ–≤–æ–≥–æ —Å–ª–µ–¥–∞ (float32 –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –∑–∞—Ç—É—Ö–∞–Ω–∏—è)
    motion_history = np.zeros((height, width), dtype=np.float32)
    
    frame_count = 0
    
    print("üöÄ –ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏...")
    
    while True:
        ret, frame = cap.read()
        if not ret:
            break
            
        frame_count += 1
        
        # --- –≠–¢–ê–ü 1: –†–∞–∑–±–∏–µ–Ω–∏–µ –∏ –∞–Ω–∞–ª–∏–∑ (–°–∫—Ä–∏–Ω—à–æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞) ---
        current_gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
        
        # –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É —Ç–µ–∫—É—â–∏–º –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∫–∞–¥—Ä–æ–º (detect motion)
        diff = cv2.absdiff(current_gray, prev_gray)
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º —à—É–º—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
        _, mask = cv2.threshold(diff, threshold, 255, cv2.THRESH_BINARY)
        
        # --- –≠–¢–ê–ü 2: –ù–∞–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–ø–ª–æ–≤–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ –∏ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ ---
        
        # 1. –£–º–µ–Ω—å—à–∞–µ–º —è—Ä–∫–æ—Å—Ç—å –≤—Å–µ–π –∫–∞—Ä—Ç—ã –∏—Å—Ç–æ—Ä–∏–∏ (—ç—Ñ—Ñ–µ–∫—Ç —Å—Ç–∞—Ä–µ–Ω–∏—è/–∑–∞—Ç—É—Ö–∞–Ω–∏—è)
        # –í—ã—á–∏—Ç–∞–µ–º decay_speed –∏–∑ –≤—Å–µ—Ö –ø–∏–∫—Å–µ–ª–µ–π, –Ω–æ –Ω–µ –¥–∞–µ–º —É–π—Ç–∏ –Ω–∏–∂–µ 0
        motion_history = np.maximum(0, motion_history - decay_speed)
        
        # 2. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
        # –¢–∞–º, –≥–¥–µ –º–∞—Å–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –±–µ–ª–∞—è (–µ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ), —Å—Ç–∞–≤–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —è—Ä–∫–æ—Å—Ç—å (255)
        # np.where(—É—Å–ª–æ–≤–∏–µ, –∑–Ω–∞—á–µ–Ω–∏–µ_–µ—Å–ª–∏_–¥–∞, –∑–Ω–∞—á–µ–Ω–∏–µ_–µ—Å–ª–∏_–Ω–µ—Ç)
        motion_history = np.where(mask > 0, 255, motion_history)
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –æ–±—Ä–∞—Ç–Ω–æ –≤ –±–∞–π—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç (0-255) –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏
        heatmap_gray = motion_history.astype(np.uint8)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–æ–≤—É—é —Å—Ö–µ–º—É "JET" (—Å–∏–Ω–∏–π -> –∑–µ–ª–µ–Ω—ã–π -> –∫—Ä–∞—Å–Ω—ã–π)
        # –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É –ø–æ—Ö–æ–∂–µ–π –Ω–∞ —Ç–µ–ø–ª–æ–≤–∏–∑–æ—Ä
        heatmap_color = cv2.applyColorMap(heatmap_gray, cv2.COLORMAP_JET)
        
        # --- –°–±–æ—Ä–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–∞–¥—Ä–∞ ---
        
        # –í–∞—Ä–∏–∞–Ω—Ç –ê: –¢–æ–ª—å–∫–æ —Ç–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –Ω–∞ —á–µ—Ä–Ω–æ–º —Ñ–æ–Ω–µ
        # final_frame = heatmap_color
        
        # –í–∞—Ä–∏–∞–Ω—Ç –ë: –ù–∞–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã –Ω–∞ –∑–∞—Ç–µ–º–Ω–µ–Ω–Ω–æ–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
        # –ó–∞—Ç–µ–º–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
        dark_frame = (frame * 0.5).astype(np.uint8)
        # –°–∫–ª–∞–¥—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –¢–∞–º –≥–¥–µ heatmap —á–µ—Ä–Ω—ã–π - –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –≤–∏–¥–µ–æ. –¢–∞–º –≥–¥–µ —Ü–≤–µ—Ç–Ω–æ–π - –ø–µ—Ä–µ–∫—Ä–æ–µ—Ç.
        # –ù–æ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å addWeighted –¥–ª—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏
        final_frame = cv2.addWeighted(dark_frame, 0.6, heatmap_color, 0.4, 0)
        
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–∞–¥—Ä –≤ –Ω–æ–≤–æ–µ –≤–∏–¥–µ–æ
        out.write(final_frame)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º "–ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–∞–¥—Ä"
        prev_gray = current_gray
        
        # –í—ã–≤–æ–¥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        if frame_count % 30 == 0:
            percent = int(frame_count / total_frames * 100)
            sys.stdout.write(f"\r‚è≥ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {percent}% ({frame_count}/{total_frames})")
            sys.stdout.flush()

    # –û—á–∏—Å—Ç–∫–∞
    cap.release()
    out.release()
    print(f"\n‚úÖ –ì–æ—Ç–æ–≤–æ! –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: {output_path}")

if __name__ == "__main__":
    print("=== –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã –¥–≤–∏–∂–µ–Ω–∏—è ===")
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç–∏
    if len(sys.argv) > 1:
        v_path = sys.argv[1]
    else:
        v_path = input("–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ –≤–∏–¥–µ–æ —Ñ–∞–π–ª—É (mp4, avi): ").strip('"')
    
    if not os.path.exists(v_path):
        print("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    else:
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        dir_name, file_name = os.path.split(v_path)
        name_only, ext = os.path.splitext(file_name)
        out_path = os.path.join(dir_name, f"{name_only}_heatmap.mp4")
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –ø—Ä—è–º–æ —Ç—É—Ç)
        DECAY = 2.0      # –°–∫–æ—Ä–æ—Å—Ç—å –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è (0.5 - –º–µ–¥–ª–µ–Ω–Ω–æ, 5.0 - –±—ã—Å—Ç—Ä–æ)
        SENSITIVITY = 30 # –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (10 - –≤–∏–¥–∏—Ç –¥–∞–∂–µ —à—É–º, 50 - —Ç–æ–ª—å–∫–æ –∫—Ä—É–ø–Ω—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è)
        
        create_motion_heatmap_video(v_path, out_path, decay_speed=DECAY, threshold=SENSITIVITY)
